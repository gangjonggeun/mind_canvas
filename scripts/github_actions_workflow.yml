# GitHub Actions Workflow for Mind Canvas
# .github/workflows/test.yml

name: ğŸ§ª Mind Canvas Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œì— ì‹¤í–‰ (UTC)
    - cron: '0 2 * * *'

env:
  FLUTTER_VERSION: '3.24.0'
  MIN_COVERAGE: '80'

jobs:
  # =====================================
  # ì •ì  ë¶„ì„ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # =====================================
  code-quality:
    name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
      
    - name: ğŸ”§ ì½”ë“œ ìƒì„±
      run: |
        if grep -q "build_runner" pubspec.yaml; then
          flutter packages pub run build_runner build --delete-conflicting-outputs
        fi
        
    - name: ğŸ” ì •ì  ë¶„ì„
      run: flutter analyze --fatal-infos
      
    - name: ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
      run: flutter format --dry-run --set-exit-if-changed .
      
    - name: ğŸ›¡ï¸  ë³´ì•ˆ ê²€ì‚¬
      run: |
        # ë¯¼ê°í•œ ì •ë³´ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if grep -r -i -E "(password|api[_-]?key|secret|token).*=.*['\"][^'\"]+['\"]" lib/ test/ || true; then
          echo "âš ï¸ ë¯¼ê°í•œ ì •ë³´ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        fi

  # =====================================
  # ìœ ë‹› ë° ìœ„ì ¯ í…ŒìŠ¤íŠ¸
  # =====================================
  unit-tests:
    name: ğŸ§ª ìœ ë‹› & ìœ„ì ¯ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
      
    - name: ğŸ”§ ì½”ë“œ ìƒì„±
      run: |
        if grep -q "build_runner" pubspec.yaml; then
          flutter packages pub run build_runner build --delete-conflicting-outputs
        fi
        
    - name: ğŸ§ª ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        if [ -d "test/unit" ]; then
          flutter test test/unit/ --coverage --reporter=github
        else
          echo "ìœ ë‹› í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: ğŸ–¼ï¸ ìœ„ì ¯ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        if [ -d "test/widget" ]; then
          flutter test test/widget/ --coverage --reporter=github
        else
          echo "ìœ„ì ¯ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: ğŸ“Š ì»¤ë²„ë¦¬ì§€ í™•ì¸
      run: |
        if [ -f "coverage/lcov.info" ]; then
          echo "ì»¤ë²„ë¦¬ì§€ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          # ê°„ë‹¨í•œ ì»¤ë²„ë¦¬ì§€ ì²´í¬ (lcov ì—†ì´)
          lines=$(grep -c "^LF:" coverage/lcov.info || echo "0")
          hit_lines=$(grep -c "^LH:" coverage/lcov.info || echo "0")
          if [ "$lines" -gt 0 ]; then
            coverage=$(( hit_lines * 100 / lines ))
            echo "í˜„ì¬ ì»¤ë²„ë¦¬ì§€: ${coverage}%"
            if [ "$coverage" -lt "$MIN_COVERAGE" ]; then
              echo "âŒ ì»¤ë²„ë¦¬ì§€ê°€ ìµœì†Œ ìš”êµ¬ì‚¬í•­(${MIN_COVERAGE}%)ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤."
              exit 1
            fi
          fi
        fi
        
    - name: ğŸ“¤ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # =====================================
  # í†µí•© í…ŒìŠ¤íŠ¸ (Android)
  # =====================================
  integration-tests-android:
    name: ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ (Android)
    runs-on: macos-latest
    timeout-minutes: 30
    needs: unit-tests
    
    strategy:
      matrix:
        api-level: [29, 33]
        
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: â˜• Java ì„¤ì •
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
      
    - name: ğŸ¤– Android ì—ë®¬ë ˆì´í„° ì‹¤í–‰
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: ${{ matrix.api-level }}
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        script: |
          if [ -d "test/integration" ]; then
            flutter test test/integration/ --reporter=github
          else
            echo "í†µí•© í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

  # =====================================
  # í†µí•© í…ŒìŠ¤íŠ¸ (iOS)
  # =====================================
  integration-tests-ios:
    name: ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ (iOS)
    runs-on: macos-latest
    timeout-minutes: 25
    needs: unit-tests
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
      
    - name: ğŸ iOS ì‹œë®¬ë ˆì´í„° ì‹¤í–‰
      run: |
        # iOS ì‹œë®¬ë ˆì´í„° ì‹œì‘
        xcrun simctl boot "iPhone 14" || true
        
        if [ -d "test/integration" ]; then
          flutter test test/integration/ -d "iPhone 14" --reporter=github
        else
          echo "í†µí•© í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi

  # =====================================
  # ë¹Œë“œ í…ŒìŠ¤íŠ¸
  # =====================================
  build-tests:
    name: ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: code-quality
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: android,web
          - os: macos-latest
            platform: ios,macos
          - os: windows-latest
            platform: windows
            
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: â˜• Java ì„¤ì • (Androidìš©)
      if: contains(matrix.platform, 'android')
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
      
    - name: ğŸ”§ í”Œë«í¼ í™œì„±í™”
      run: |
        if [[ "${{ matrix.platform }}" == *"web"* ]]; then
          flutter config --enable-web
        fi
        if [[ "${{ matrix.platform }}" == *"macos"* ]]; then
          flutter config --enable-macos-desktop
        fi
        if [[ "${{ matrix.platform }}" == *"windows"* ]]; then
          flutter config --enable-windows-desktop
        fi
        
    - name: ğŸ¤– Android ë¹Œë“œ
      if: contains(matrix.platform, 'android')
      run: flutter build apk --debug
      
    - name: ğŸ iOS ë¹Œë“œ
      if: contains(matrix.platform, 'ios')
      run: flutter build ios --debug --simulator
      
    - name: ğŸŒ Web ë¹Œë“œ
      if: contains(matrix.platform, 'web')
      run: flutter build web --debug
      
    - name: ğŸ–¥ï¸ macOS ë¹Œë“œ
      if: contains(matrix.platform, 'macos')
      run: flutter build macos --debug
      
    - name: ğŸªŸ Windows ë¹Œë“œ
      if: contains(matrix.platform, 'windows')
      run: flutter build windows --debug
      
    - name: ğŸ“Š ë¹Œë“œ í¬ê¸° í™•ì¸
      run: |
        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          size=$(du -h "build/app/outputs/flutter-apk/app-debug.apk" | cut -f1)
          echo "APK í¬ê¸°: $size"
          
          # 20MB ì´ˆê³¼ ì‹œ ê²½ê³ 
          size_mb=$(du -m "build/app/outputs/flutter-apk/app-debug.apk" | cut -f1)
          if [ "$size_mb" -gt 20 ]; then
            echo "âš ï¸ APK í¬ê¸°ê°€ í½ë‹ˆë‹¤: ${size_mb}MB"
          fi
        fi

  # =====================================
  # ì„±ëŠ¥ ë° ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  # =====================================
  performance-security:
    name: âš¡ ì„±ëŠ¥ & ë³´ì•ˆ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [unit-tests, build-tests]
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“± Flutter ì„¤ì •
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: flutter pub get
      
    - name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº”
      run: |
        echo "ğŸ” ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬..."
        # pubspec.yamlì˜ ì•Œë ¤ì§„ ì·¨ì•½í•œ íŒ¨í‚¤ì§€ í™•ì¸
        if grep -q "http: 0.12" pubspec.yaml; then
          echo "âš ï¸ ì˜¤ë˜ëœ http íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤."
        fi
        
    - name: âš¡ ì„±ëŠ¥ ë¶„ì„
      run: |
        echo "ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„..."
        # ê°„ë‹¨í•œ ë©”íŠ¸ë¦­ìŠ¤ ìˆ˜ì§‘
        echo "Dart íŒŒì¼ ìˆ˜: $(find lib -name "*.dart" | wc -l)"
        echo "ì´ ì½”ë“œ ë¼ì¸ ìˆ˜: $(find lib -name "*.dart" -exec wc -l {} + | tail -1)"
        
        # TODO ë° FIXME í™•ì¸
        todos=$(grep -r "TODO\|FIXME" lib/ || true)
        if [ ! -z "$todos" ]; then
          echo "âš ï¸ í•´ê²°ë˜ì§€ ì•Šì€ TODO/FIXMEê°€ ìˆìŠµë‹ˆë‹¤:"
          echo "$todos"
        fi

  # =====================================
  # ê²°ê³¼ ìš”ì•½ ë° ì•Œë¦¼
  # =====================================
  test-summary:
    name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ìš”ì•½
    runs-on: ubuntu-latest
    if: always()
    needs: [code-quality, unit-tests, integration-tests-android, integration-tests-ios, build-tests, performance-security]
    
    steps:
    - name: ğŸ“Š ê²°ê³¼ ìš”ì•½
      run: |
        echo "ğŸ¯ Mind Canvas í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
        echo "================================"
        
        # ê° jobì˜ ê²°ê³¼ í™•ì¸
        echo "ì½”ë“œ í’ˆì§ˆ: ${{ needs.code-quality.result }}"
        echo "ìœ ë‹› í…ŒìŠ¤íŠ¸: ${{ needs.unit-tests.result }}"
        echo "Android í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.integration-tests-android.result }}"
        echo "iOS í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.integration-tests-ios.result }}"
        echo "ë¹Œë“œ í…ŒìŠ¤íŠ¸: ${{ needs.build-tests.result }}"
        echo "ì„±ëŠ¥/ë³´ì•ˆ: ${{ needs.performance-security.result }}"
        
        # ì „ì²´ ê²°ê³¼ íŒë‹¨
        if [[ "${{ needs.code-quality.result }}" == "success" && \
              "${{ needs.unit-tests.result }}" == "success" && \
              ("${{ needs.integration-tests-android.result }}" == "success" || "${{ needs.integration-tests-android.result }}" == "skipped") && \
              ("${{ needs.integration-tests-ios.result }}" == "success" || "${{ needs.integration-tests-ios.result }}" == "skipped") && \
              "${{ needs.build-tests.result }}" == "success" && \
              "${{ needs.performance-security.result }}" == "success" ]]; then
          echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
        else
          echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
        fi
